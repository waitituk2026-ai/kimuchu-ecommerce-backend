<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Orders (Polished)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#667;--accent:#0b6}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;background:var(--bg);color:#111}
    .wrap{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:1.3rem}
    .controls{display:flex;gap:8px;align-items:center}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(12,14,25,.06)}
    input,select{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #f0f0f5;text-align:left;vertical-align:top}
    th{background:#fafafa;font-weight:600;font-size:.95rem;color:#333}
    .small{font-size:.86rem;color:var(--muted)}
    .badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;font-size:.85rem}
    .paid{background:#e6f7ee;color:green}
    .notpaid{background:#fff0f0;color:#c00}
    button{background:var(--accent);color:#042;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:#222;border:1px solid #e6e9ef}
    .actions button{margin-right:6px}
    .pager{display:flex;gap:8px;align-items:center;margin-top:12px}
    .muted{color:var(--muted)}
    pre{white-space:pre-wrap;word-break:break-all}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Orders</h1>
        <div class="small">Search, filter, paginate and export CSV. Admin-only.</div>
      </div>

      <div class="controls">
        <label class="small">Search<input id="searchInput" placeholder="order id or product name" style="margin-left:6px"/></label>
        <label class="small">Status
          <select id="statusFilter" style="margin-left:6px">
            <option value="all">All</option>
            <option value="paid">Paid</option>
            <option value="notpaid">Not Paid</option>
          </select>
        </label>
        <label class="small">Page size
          <select id="pageSize" style="margin-left:6px">
            <option>5</option><option>10</option><option>20</option>
          </select>
        </label>

        <button id="refreshBtn" class="ghost">Refresh</button>
        <button id="exportCsv">Export CSV</button>
      </div>
    </header>

    <section class="card">
      <div id="stats" class="small muted">Loading…</div>

      <table aria-live="polite" id="ordersTable" role="table">
        <thead>
          <tr>
            <th style="width:20%">Order ID</th>
            <th style="width:36%">Items</th>
            <th style="width:10%">Total (KES)</th>
            <th style="width:12%">Phone</th>
            <th style="width:10%">Status</th>
            <th style="width:12%">Actions</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr><td colspan="6" class="small muted">No data yet.</td></tr>
        </tbody>
      </table>

      <div class="pager" style="justify-content:space-between">
        <div class="small muted" id="pageInfo">Page 1</div>
        <div>
          <button id="prevPage" class="ghost">Prev</button>
          <button id="nextPage" class="ghost">Next</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const API = '/api/orders';
    let allOrders = [];
    let filtered = [];
    let page = 1;
    let pageSize = Number(document.getElementById('pageSize').value || 5);

    const els = {
      search: document.getElementById('searchInput'),
      status: document.getElementById('statusFilter'),
      pageSize: document.getElementById('pageSize'),
      ordersBody: document.getElementById('ordersBody'),
      stats: document.getElementById('stats'),
      pageInfo: document.getElementById('pageInfo'),
      prev: document.getElementById('prevPage'),
      next: document.getElementById('nextPage'),
      refresh: document.getElementById('refreshBtn'),
      exportCsv: document.getElementById('exportCsv')
    };

    function formatItems(items){
      if(!items || items.length===0) return '';
      return items.map(i => `${i.name} × ${i.qty} (KES ${Number(i.price).toFixed(2)})`).join('<br/>');
    }

    function renderPage(){
      pageSize = Number(els.pageSize.value);
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if (page > pages) page = pages;
      const start = (page-1)*pageSize;
      const slice = filtered.slice(start, start + pageSize);

      if(slice.length===0){
        els.ordersBody.innerHTML = '<tr><td colspan="6" class="small muted">No orders to show.</td></tr>';
      } else {
        els.ordersBody.innerHTML = slice.map(order => {
          const itemsHtml = formatItems(order.items || []);
          const statusHtml = order.isPaid ? '<span class="badge paid">Paid</span>' : '<span class="badge notpaid">Not paid</span>';
          const actions = order.isPaid ? '' : `<div class="actions"><button onclick="markPaid('${order._id}')" title="Mark paid">Mark Paid</button></div>`;
          return `<tr>
            <td><pre>${order._id}</pre><div class="small muted">${new Date(order.createdAt).toLocaleString()}</div></td>
            <td>${itemsHtml}</td>
            <td>${Number(order.total||0).toFixed(2)}</td>
            <td>${order.phone || ''}</td>
            <td>${statusHtml}</td>
            <td>${actions}</td>
          </tr>`;
        }).join('');
      }

      els.stats.innerText = `Total orders: ${total} • Page ${page} / ${pages}`;
      els.pageInfo.innerText = `Showing ${Math.min(total, (page*pageSize))} of ${total}`;
      els.prev.disabled = page<=1;
      els.next.disabled = page>=pages;
    }

    function applyFilters(){
      const q = (els.search.value || '').trim().toLowerCase();
      const status = els.status.value;
      filtered = allOrders.filter(o => {
        if(status === 'paid' && !o.isPaid) return false;
        if(status === 'notpaid' && o.isPaid) return false;
        if(!q) return true;
        // search in id or item names
        if((o._id || '').toLowerCase().includes(q)) return true;
        if((o.phone || '').toLowerCase().includes(q)) return true;
        const inItems = (o.items||[]).some(it => (it.name||'').toLowerCase().includes(q));
        return inItems;
      });
      page = 1;
      renderPage();
    }

    async function fetchOrders(){
      try {
        const res = await fetch(API, { cache: 'no-store' });
        if(!res.ok) throw new Error('Failed to fetch orders: ' + res.status);
        allOrders = await res.json();
        // ensure boolean field presence
        allOrders = allOrders.map(o => ({ isPaid: !!o.isPaid, ...o }));
        applyFilters();
      } catch (err) {
        console.error(err);
        els.ordersBody.innerHTML = `<tr><td colspan="6" class="small muted">Error loading orders: ${err.message}</td></tr>`;
      }
    }

    async function markPaid(id){
      if(!confirm('Mark order ' + id + ' as paid?')) return;
      try {
        const r = await fetch(`${API}/${id}/pay`, { method: 'PATCH' });
        if(!r.ok) {
          const txt = await r.text();
          throw new Error(txt || 'Failed');
        }
        alert('Marked paid ✅');
        await fetchOrders();
      } catch (err) {
        console.error(err);
        alert('Error: ' + (err.message || 'unknown'));
      }
    }

    function exportToCsv(){
      // export currently filtered (all pages) for admin
      const rows = [
        ['orderId','createdAt','total','phone','isPaid','items']
      ];
      filtered.forEach(o => {
        const items = (o.items||[]).map(i=>`${i.name} x ${i.qty} (${i.price})`).join(' | ');
        rows.push([o._id, o.createdAt, Number(o.total||0).toFixed(2), o.phone||'', o.isPaid ? 'paid' : 'notpaid', items]);
      });
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `orders_export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // events
    els.search.addEventListener('input', () => applyFilters());
    els.status.addEventListener('change', () => applyFilters());
    els.pageSize.addEventListener('change', () => { page = 1; renderPage(); });
    els.prev.addEventListener('click', () => { if(page>1){page--; renderPage();} });
    els.next.addEventListener('click', () => { page++; renderPage(); });
    els.refresh.addEventListener('click', () => fetchOrders());
    els.exportCsv.addEventListener('click', exportToCsv);

    // initial load
    fetchOrders();
    // auto-refresh every 12s so admin sees new orders (optional)
    const AUTO_REFRESH_MS = 12000;
    setInterval(fetchOrders, AUTO_REFRESH_MS);
  </script>
</body>
</html>
